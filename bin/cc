#!/usr/bin/env php
<?php
declare(strict_types=1);

use Calc\Calculator;
use Calc\Exception\SyntaxErrorException;
use Symfony\Component\Console\Output\StreamOutput;

$autoloaderPaths = [
    __DIR__ . '/../../../autoload.php',
    __DIR__ . '/../../autoload.php',
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/vendor/autoload.php',
];

foreach ($autoloaderPaths as $file) {
    if (is_file($file)) {
        require $file;
        break;
    }
}


$output = new StreamOutput(STDOUT);

$output->writeln('<info> Hello Stranger! </info>');
$output->writeln('<comment> // Write an expression (like "2+2") to get an answer</comment>');
$output->writeln('<comment> // Write "exit" to exit (Vnezapno!)</comment>');

$calc = new Calculator();

while (! $expression = '') {
    while (! $expression) {
        $output->write('<question> > </question> ');
        $expression = \trim(\preg_replace('/\s+/', ' ', fgets(STDIN)));
    }

    if (\strtolower($expression) === 'exit') {
        $output->writeln('<question>   </question> <info>Bye!</info>');
        exit(0);
    }

    $expression = \trim($expression);

    try {
        $output->writeln(vsprintf('<question>   </question> <info>%s</info> <comment>(%s)</comment>', [
            $result = $calc->calc($expression),
            \is_int($result) ? 'int' : 'float',
        ]));
    } catch (SyntaxErrorException $error) {
        foreach (error($error, $expression) as $line) {
            $output->writeln(sprintf('<fg=white;bg=red;options=bold>     %s     </>', $line));
        }
    } catch (\Throwable $e) {
        $output->writeln('Fatal Error: ' . $e->getMessage());

        exit($e->getCode() ?: -1);
    }
}

function message_delimiter(string $message): string
{
    return \str_repeat(' ', \strlen($message));
}

function error(SyntaxErrorException $error, string $expr): iterable
{
    $token = $error->getToken();
    $offset = $token->getOffset();

    $message = \sprintf('Syntax error in %s at offset %d', $token, $offset);
    $length = \strlen($message);

    yield message_delimiter($message);
    yield $message;
    yield message_delimiter($message);

    yield \str_pad('"' . $expr . '"', $length);
    yield \str_pad(
        \str_repeat(' ', $offset + 1) .
        \str_repeat('^', \mb_strlen($token->getValue())),
        $length
    );
    yield message_delimiter($message);
}
